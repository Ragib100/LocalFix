# PostgreSQL Migration Guide

## Overview
All database migration files have been converted from Oracle SQL to PostgreSQL. This document outlines the key changes and how to use the migrations.

## Key Changes from Oracle to PostgreSQL

### Data Types
- `NUMBER` → `INTEGER` or `SERIAL` (for auto-increment)
- `NUMBER(10,2)` → `NUMERIC(10,2)`
- `VARCHAR2` → `VARCHAR`
- `CLOB` → `TEXT`

### Identity Columns
- `NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY` → `SERIAL PRIMARY KEY`

### Sequences
- Oracle: `CREATE SEQUENCE seq_name START WITH 1000`
- PostgreSQL: `CREATE SEQUENCE IF NOT EXISTS seq_name START WITH 1000`

### Triggers
Oracle triggers are converted to PostgreSQL trigger functions:

**Oracle:**
```sql
CREATE OR REPLACE TRIGGER trg_name
BEFORE UPDATE ON table_name
FOR EACH ROW
BEGIN
    :NEW.updated_at := CURRENT_TIMESTAMP;
END;
/
```

**PostgreSQL:**
```sql
CREATE OR REPLACE FUNCTION trg_name()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at := CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_name
BEFORE UPDATE ON table_name
FOR EACH ROW
EXECUTE FUNCTION trg_name();
```

### Exception Handling
- `RAISE_APPLICATION_ERROR(-20001, 'message')` → `RAISE EXCEPTION 'message'`
- `NVL(value, 0)` → `COALESCE(value, 0)`
- `SQL%ROWCOUNT` → `GET DIAGNOSTICS var = ROW_COUNT`

### Stored Procedures/Functions
- Oracle procedures with `IN`/`OUT` parameters → PostgreSQL functions
- Oracle: `RETURN NUMBER` → PostgreSQL: `RETURNS INTEGER`
- Oracle: `VARCHAR2` → PostgreSQL: `VARCHAR`

### Other Changes
- Removed `COMMIT;` statements (handled by transaction management)
- Removed Oracle-specific PL/SQL blocks for sequence creation
- Compound triggers converted to simpler AFTER triggers
- `FROM dual` replaced with `VALUES` clause

## Running the Migrations

### Using psql command line:
```bash
# Connect to your PostgreSQL database
psql -U your_username -d your_database

# Run migrations in order
\i database/migrations/001_create_users_table.sql
\i database/migrations/002_create_locations_table.sql
\i database/migrations/003_create_issues_table.sql
\i database/migrations/004_create_applications_table.sql
\i database/migrations/005_create_issue_proofs_table.sql
\i database/migrations/006_create_payments_table.sql
\i database/migrations/007_create_ratings_table.sql
\i database/migrations/008_create_withdrawals_table.sql
```

### Or use the master script:
```bash
cd database/migrations
psql -U your_username -d your_database -f 999_run_all_migrations.sql
```

## Migration Files

1. **001_create_users_table.sql** - User accounts (citizens, workers, admins)
2. **002_create_locations_table.sql** - Location data with coordinates
3. **003_create_issues_table.sql** - Issue/problem tracking
4. **004_create_applications_table.sql** - Worker job applications with validation triggers
5. **005_create_issue_proofs_table.sql** - Work completion proofs
6. **006_create_payments_table.sql** - Payment processing
7. **007_create_ratings_table.sql** - Worker ratings
8. **008_create_withdrawals_table.sql** - Worker withdrawals + views and functions

## Database Objects Created

### Tables
- users
- locations
- issues
- applications
- issue_proofs
- payments
- ratings
- withdrawals

### Views
- `v_issues_with_details` - Issues joined with citizen and location info
- `v_worker_payment_summary` - Worker payment aggregations by status

### Functions
- `get_issue_count_by_status(worker_id, status)` - Count issues for a worker by status
- `set_issue_status_safe(issue_id, status)` - Safely update issue status with validation

### Trigger Functions
- Auto-update `updated_at` timestamps
- Validate business rules (worker assignments, admin permissions)
- Cascade status updates across related tables
- Auto-generate transaction IDs

## Seeding Data

The seed data file (`database/seeds/seed_data.sql`) is compatible with PostgreSQL with minimal changes needed. Run it after creating all tables:

```bash
psql -U your_username -d your_database -f database/seeds/seed_data.sql
```

## Verification

After running migrations, verify the setup:

```sql
-- Check tables
SELECT tablename FROM pg_tables WHERE schemaname = 'public';

-- Check views
SELECT viewname FROM pg_views WHERE schemaname = 'public';

-- Check functions
SELECT proname, prokind FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public';

-- Check triggers
SELECT trigger_name, event_object_table 
FROM information_schema.triggers 
WHERE trigger_schema = 'public';
```

## Notes

- All foreign key constraints include `ON DELETE CASCADE` where appropriate
- Triggers handle workflow validation (e.g., only workers can submit applications)
- Admin permissions are validated at the database level
- Transaction IDs are auto-generated for payments
- All timestamps use `TIMESTAMP` without timezone (consider using `TIMESTAMPTZ` for production)

## Troubleshooting

If you encounter errors:

1. Ensure PostgreSQL version is 12 or higher (for better trigger support)
2. Check that all prerequisite tables are created before dependent tables
3. Verify user permissions on the database
4. Check PostgreSQL logs for detailed error messages: `tail -f /var/log/postgresql/postgresql-*.log`
